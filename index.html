<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>QR Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
/* ===== –û–ë–©–ï–ï ===== */
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
  margin: 0;
  padding: 15px;
}

.app {
  max-width: 420px;
  margin: auto;
}

h2 {
  text-align: center;
  margin-bottom: 10px;
}

/* ===== –ö–ù–û–ü–ö–ê –°–ö–ê–ù–ï–†–ê ===== */
.scan-btn {
  width: 100%;
  margin-bottom: 12px;
  background: #34c759;
  color: white;
  font-size: 16px;
  padding: 14px;
  border-radius: 14px;
  border: none;
}
.scan-btn.off {
  background: #aaa;
}

/* ===== –°–ö–ê–ù–ï–† ===== */
#reader {
  position: relative;
  border-radius: 18px;
  overflow: hidden;
  background: black;
}

.scan-frame {
  position: absolute;
  left: 50%;
  top: 50%;
  width: 220px;
  height: 220px;
  transform: translate(-50%, -50%);
  border-radius: 18px;
  border: 3px solid rgba(255,255,255,0.9);
  box-shadow: 0 0 0 2000px rgba(0,0,0,0.35);
  pointer-events: none;
}

/* ===== –ö–ê–†–¢–û–ß–ö–ò ===== */
.card {
  background: white;
  border-radius: 16px;
  padding: 14px;
  margin-top: 15px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #eee;
}
.row:last-child {
  border-bottom: none;
}

.label {
  color: #888;
  font-size: 13px;
}

.value {
  font-size: 16px;
  font-weight: 500;
  word-break: break-word;
}

/* ===== –ö–ù–û–ü–ö–ê –ó–í–û–ù–ö–ê ===== */
.call-btn {
  background: #34c759;
  border: none;
  width: 36px;
  height: 36px;
  min-width: 36px;
  min-height: 36px;
  border-radius: 50%;
  font-size: 18px;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
}
.call-btn:disabled {
  background: #ccc;
}

/* ===== –ö–ù–û–ü–ö–ò –ö–ê–†–¢ ===== */
.buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

button {
  border: none;
  font-size: 15px;
}

.google {
  flex: 1;
  padding: 14px;
  border-radius: 14px;
  background: #4285f4;
  color: white;
}

.apple {
  flex: 1;
  padding: 14px;
  border-radius: 14px;
  background: black;
  color: white;
}

/* ===== –ò–°–¢–û–†–ò–Ø ===== */
.history-item {
  padding: 8px 0;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}
.history-item:last-child {
  border-bottom: none;
}

.delete-btn {
  margin-top: 10px;
  width: 100%;
  background: #ff3b30;
  color: white;
  padding: 14px;
  border-radius: 14px;
  border: none;
}
</style>
</head>

<body>
<div class="app">

<h2>üì∑ QR-–°–∫–∞–Ω–µ—Ä</h2>
<button id="scanToggle" class="scan-btn">‚ñ∂Ô∏è –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>

<div id="reader"></div>

<div class="card">
  <div class="row">
    <div>
      <div class="label">–ê–¥—Ä–µ—Å</div>
      <div class="value" id="address">‚Äî</div>
    </div>
  </div>

  <div class="row">
    <div>
      <div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
      <div class="value" id="phone">‚Äî</div>
    </div>
    <button class="call-btn" id="callBtn" disabled>üìû</button>
  </div>

  <div class="row">
    <div>
      <div class="label">Betrag</div>
      <div class="value" id="amount">‚Äî</div>
    </div>
  </div>
</div>

<div class="buttons">
  <button class="google" id="googleBtn" disabled>Google Maps</button>
  <button class="apple" id="appleBtn" disabled>Apple Maps</button>
</div>

<div class="card">
  <div class="label">–ò—Å—Ç–æ—Ä–∏—è</div>
  <div id="history"></div>
  <button class="delete-btn" id="clearHistory">üóë –£–¥–∞–ª–∏—Ç—å</button>
</div>

</div>

<script>
const addressEl = document.getElementById("address");
const phoneEl = document.getElementById("phone");
const amountEl = document.getElementById("amount");

const callBtn = document.getElementById("callBtn");
const googleBtn = document.getElementById("googleBtn");
const appleBtn = document.getElementById("appleBtn");
const scanToggle = document.getElementById("scanToggle");

let qr;
let scannerRunning = false;
let scanTimer = null;
let lastScanText = "";

let history = JSON.parse(localStorage.getItem("qrHistory") || "[]");

function parseQR(text) {
  if (text === lastScanText) return;
  lastScanText = text;

  let address = "", phone = "", amount = "";

  const parts = text.split(";");
  address = parts[0]?.trim() || "";

  parts.forEach(p => {
    if (p.startsWith("T=")) phone = p.substring(2).trim();
    if (p.startsWith("B=")) amount = p.substring(2).replace(",", ".").trim();
  });

  addressEl.textContent = address || "‚Äî";
  phoneEl.textContent = phone || "‚Äî";
  amountEl.textContent = amount || "‚Äî";

  callBtn.disabled = !phone;
  googleBtn.disabled = !address;
  appleBtn.disabled = !address;

  history.unshift({ address, phone, amount, time: new Date().toLocaleString() });
  history = history.slice(0, 50);
  localStorage.setItem("qrHistory", JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const box = document.getElementById("history");
  box.innerHTML = "";
  history.forEach(item => {
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `<b>${item.address}</b><br>üìû ${item.phone} | üí∂ ${item.amount}<br><small>${item.time}</small>`;
    box.appendChild(div);
  });
}

callBtn.onclick = () => location.href = "tel:" + phoneEl.textContent;
googleBtn.onclick = () => location.href =
  "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(addressEl.textContent);
appleBtn.onclick = () => location.href =
  "https://maps.apple.com/?q=" + encodeURIComponent(addressEl.textContent);

function startScanner() {
  if (scannerRunning) return;
  lastScanText = "";

  document.getElementById("reader").innerHTML = '<div class="scan-frame"></div>';
  qr = new Html5Qrcode("reader");
  scannerRunning = true;

  scanToggle.textContent = "‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å";
  scanToggle.classList.add("off");

  qr.start(
    { facingMode: "environment" },
    { fps: 20, qrbox: { width: 220, height: 220 } },
    text => {
      stopScanner();
      parseQR(text);
    }
  );

  scanTimer = setTimeout(stopScanner, 5000);
}

function stopScanner() {
  if (!scannerRunning) return;
  qr.stop().catch(()=>{});
  scannerRunning = false;
  scanToggle.textContent = "‚ñ∂Ô∏è –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å";
  scanToggle.classList.remove("off");
  clearTimeout(scanTimer);
}

scanToggle.onclick = () => {
  scannerRunning ? stopScanner() : startScanner();
};

document.getElementById("clearHistory").onclick = () => {
  history = [];
  localStorage.removeItem("qrHistory");
  renderHistory();
};

renderHistory();
</script>

</body>
</html>
