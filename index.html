<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>QR Driver App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
}

/* -------- Pages -------- */
.page {
  display: none;
  padding: 15px;
  padding-bottom: 90px;
}
.page.active { display: block; }

/* -------- Bottom Nav -------- */
.bottom-nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: 70px;
  background: #fff;
  border-top: 1px solid #ddd;
  display: flex;
  justify-content: space-around;
  align-items: center;
}
.bottom-nav button {
  background: none;
  border: none;
  font-size: 14px;
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #555;
}
.bottom-nav button.active { color: #ff9500; }

/* -------- Scanner -------- */
.scan-btn {
  width: 100%;
  background: #34c759;
  color: white;
  padding: 14px;
  border-radius: 14px;
  border: none;
  font-size: 16px;
}
#reader {
  margin-top: 10px;
  border-radius: 16px;
  overflow: hidden;
  background: black;
  height: 60vh;
}

/* -------- Cards -------- */
.card {
  background: white;
  padding: 14px;
  border-radius: 16px;
  margin-bottom: 14px;
  box-shadow: 0 4px 10px rgba(0,0,0,.08);
}
.row {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
}
.label { color: #888; font-size: 13px; }

/* -------- Address List -------- */
#adressList li {
  list-style: none;
  background: #fff;
  margin-bottom: 8px;
  padding: 12px;
  border-radius: 12px;
  display: flex;
  justify-content: space-between;
  cursor: pointer;
}
#adressList li.active { background: #d1f7c4; }

/* -------- Inputs -------- */
input {
  width: 110px;
  padding: 6px;
  border-radius: 10px;
  border: 1px solid #ccc;
}
</style>
</head>

<body>

<!-- ================= SCANNER ================= -->
<section id="page-scanner" class="page active">
  <h2>ğŸ“· Scanner</h2>
  <button class="scan-btn" id="scanToggle">â–¶ï¸ Scannen</button>
  <div id="reader"></div>

  <div class="card">
    <div class="row"><span>Adresse</span><b id="address">â€”</b></div>
    <div class="row"><span>Telefon</span><b id="phone">â€”</b></div>
    <div class="row"><span>Betrag</span><b id="amount">â€”</b></div>
  </div>
</section>

<!-- ================= LISTE ================= -->
<section id="page-list" class="page">
  <h2>ğŸ“‹ Alle Adressen</h2>
  <button class="scan-btn" onclick="toggleAll()">Alle markieren</button>
  <ul id="adressList"></ul>
</section>

<!-- ================= REPORT ================= -->
<section id="page-report" class="page">
  <h2>ğŸ“Š Schichtbericht</h2>
  <div class="card">
    <div class="row"><span>Anzahl</span><b id="repCount">0</b></div>
    <div class="row"><span>Summe â‚¬</span><b id="repSum">0.00</b></div>
    <div class="row"><span>Lohn</span><input id="lohn"></div>
    <div class="row"><span>Benzin</span><input id="benzin"></div>
    <div class="row"><span>Sonstige</span><input id="sonstige"></div>
    <div class="row"><b>Ergebnis</b><b id="repResult">0.00</b></div>
  </div>
</section>

<!-- ================= NAV ================= -->
<nav class="bottom-nav">
  <button id="btn-scanner" class="active" onclick="showPage('scanner')">ğŸ“·<small>Scanner</small></button>
  <button id="btn-list" onclick="showPage('list')">ğŸ“‹<small>Liste</small></button>
  <button id="btn-report" onclick="showPage('report')">ğŸ“Š<small>Report</small></button>
</nav>

<script>
/* -------- Navigation -------- */
function showPage(p) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.bottom-nav button').forEach(x => x.classList.remove('active'));
  document.getElementById('page-' + p).classList.add('active');
  document.getElementById('btn-' + p).classList.add('active');
  if (p === 'list') renderList();
  if (p === 'report') updateReport();
}

/* -------- Data -------- */
let history = JSON.parse(localStorage.getItem("qrHistory") || "[]");

/* -------- QR -------- */
let qr, running = false;
const scanToggle = document.getElementById("scanToggle");

function parseQR(text) {
  let address="", phone="", amount="";
  text.split(";").forEach(p=>{
    if(p.startsWith("T=")) phone=p.slice(2);
    if(p.startsWith("B=")) amount=p.slice(2);
    if(!p.includes("=")) address=p;
  });

  const item = {
    address, phone, amount,
    date: new Date().toISOString().slice(0,10),
    active: false
  };

  if (!history.some(h =>
    h.address===item.address &&
    h.phone===item.phone &&
    h.amount===item.amount
  )) {
    history.unshift(item);
    localStorage.setItem("qrHistory", JSON.stringify(history));
  }

  document.getElementById("address").textContent = address;
  document.getElementById("phone").textContent = phone;
  document.getElementById("amount").textContent = amount;
}

function startScan() {
  if(running) return;
  qr = new Html5Qrcode("reader");
  running = true;
  scanToggle.textContent = "â¹ Stop";
  qr.start({facingMode:"environment"}, {fps:10, qrbox:220},
    txt => { stopScan(); parseQR(txt); }
  );
}
function stopScan() {
  if(!running) return;
  qr.stop(); running=false;
  scanToggle.textContent = "â–¶ï¸ Scannen";
}
scanToggle.onclick = ()=> running ? stopScan() : startScan();

/* -------- List -------- */
function renderList() {
  const ul = document.getElementById("adressList");
  ul.innerHTML="";
  history
    .sort((a,b)=>a.address.localeCompare(b.address))
    .forEach((i,idx)=>{
      const li=document.createElement("li");
      li.className=i.active?"active":"";
      li.innerHTML=`<span>${i.address}</span><b>${i.amount}â‚¬</b>`;
      li.onclick=()=>{i.active=!i.active; save(); renderList();}
      ul.appendChild(li);
    });
}

function toggleAll() {
  const all = history.every(i=>i.active);
  history.forEach(i=>i.active=!all);
  save(); renderList();
}

/* -------- Report -------- */
function updateReport() {
  const today = new Date().toISOString().slice(0,10);
  const items = history.filter(i=>i.date===today);
  const sum = items.reduce((a,i)=>a+(+i.amount||0),0);

  repCount.textContent = items.length;
  repSum.textContent = sum.toFixed(2);

  const lohn=+lohn.value||0;
  const benzin=+benzin.value||0;
  const sonstige=+sonstige.value||0;

  repResult.textContent=(sum-lohn-benzin-sonstige).toFixed(2);
}

["lohn","benzin","sonstige"].forEach(id=>{
  document.getElementById(id).oninput=updateReport;
});

function save() {
  localStorage.setItem("qrHistory", JSON.stringify(history));
}
</script>

</body>
</html>
