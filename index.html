<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>QR Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
  margin: 0;
  padding: 15px;
}
.app { max-width: 420px; margin: auto; }
h2 { text-align: center; margin-bottom: 10px; }

#reader {
  border-radius: 16px;
  overflow: hidden;
  background: black;
}

.card {
  background: white;
  border-radius: 16px;
  padding: 14px;
  margin-top: 15px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #eee;
}
.row:last-child { border-bottom: none; }

.label { color: #888; font-size: 13px; }
.value { font-size: 16px; font-weight: 500; }

.call-btn {
  background: #34c759;
  border: none;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  font-size: 18px;
  color: white;
}
.call-btn:disabled { background: #ccc; }

.buttons, .extra {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}
button {
  flex: 1;
  padding: 14px;
  border-radius: 14px;
  border: none;
  font-size: 15px;
}
.google { background: #4285f4; color: white; }
.apple { background: black; color: white; }
.flash { background: #ffcc00; }
.rescan { background: #ddd; }

.history-item {
  padding: 8px 0;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}
.history-item:last-child { border-bottom: none; }
.history-item b { display: block; }

button:disabled { opacity: 0.4; }
</style>
</head>

<body>
<div class="app">

<h2>üì∑ QR-–°–∫–∞–Ω–µ—Ä</h2>
<div id="reader"></div>

<div class="card">
  <div class="row">
    <div>
      <div class="label">–ê–¥—Ä–µ—Å</div>
      <div class="value" id="address">‚Äî</div>
    </div>
  </div>

  <div class="row">
    <div>
      <div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
      <div class="value" id="phone">‚Äî</div>
    </div>
    <button class="call-btn" id="callBtn" disabled>üìû</button>
  </div>

  <div class="row">
    <div>
      <div class="label">Betrag</div>
      <div class="value" id="amount">‚Äî</div>
    </div>
  </div>
</div>

<div class="buttons">
  <button class="google" id="googleBtn" disabled>Google Maps</button>
  <button class="apple" id="appleBtn" disabled>Apple Maps</button>
</div>

<div class="extra">
  <button class="flash" id="flashBtn">üî¶</button>
  <button class="rescan" id="rescanBtn">üîÅ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
</div>

<div class="card">
  <div class="label">–ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞–Ω–æ–≤</div>
  <div id="history"></div>
  <button id="clearHistory" style="margin-top:10px;background:#ff3b30;color:white;">
    üóë –û—á–∏—Å—Ç–∏—Ç—å
  </button>
</div>

</div>

<script>
const addressEl = document.getElementById("address");
const phoneEl = document.getElementById("phone");
const amountEl = document.getElementById("amount");

const callBtn = document.getElementById("callBtn");
const googleBtn = document.getElementById("googleBtn");
const appleBtn = document.getElementById("appleBtn");
const flashBtn = document.getElementById("flashBtn");
const rescanBtn = document.getElementById("rescanBtn");

let qr;
let torch = false;

let history = JSON.parse(localStorage.getItem("qrHistory") || "[]");
let lastData = {};

function parseQR(text) {
  let address="", phone="", amount="";
  const parts = text.split(";");

  if (parts[0] && !parts[0].includes("=")) address = parts[0].trim();

  parts.forEach(p => {
    if (p.startsWith("T=")) phone = p.substring(2).trim();
    if (p.startsWith("B=")) amount = p.substring(2).replace(",", ".").trim();
  });

  lastData = { address, phone, amount, time: new Date().toLocaleString() };

  addressEl.textContent = address || "‚Äî";
  phoneEl.textContent = phone || "‚Äî";
  amountEl.textContent = amount || "‚Äî";

  callBtn.disabled = !phone;
  googleBtn.disabled = !address;
  appleBtn.disabled = !address;

  history.unshift(lastData);
  history = history.slice(0, 50);
  localStorage.setItem("qrHistory", JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const box = document.getElementById("history");
  box.innerHTML = "";
  history.forEach(item => {
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `
      <b>${item.address || "‚Äî"}</b>
      üìû ${item.phone || "‚Äî"} | üí∂ ${item.amount || "‚Äî"}
      <div style="font-size:12px;color:#888">${item.time}</div>
    `;
    div.onclick = () => fill(item);
    box.appendChild(div);
  });
}

function fill(item) {
  addressEl.textContent = item.address || "‚Äî";
  phoneEl.textContent = item.phone || "‚Äî";
  amountEl.textContent = item.amount || "‚Äî";
  lastData = item;
  callBtn.disabled = !item.phone;
  googleBtn.disabled = !item.address;
  appleBtn.disabled = !item.address;
}

callBtn.onclick = () => location.href = "tel:" + lastData.phone;

googleBtn.onclick = () =>
  location.href = "https://www.google.com/maps/search/?api=1&query=" +
  encodeURIComponent(lastData.address);

appleBtn.onclick = () =>
  location.href = "https://maps.apple.com/?q=" +
  encodeURIComponent(lastData.address);

// üî¶ —Ñ–æ–Ω–∞—Ä–∏–∫ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
flashBtn.onclick = () => {
  torch = !torch;
  try {
    qr.applyVideoConstraints({ advanced: [{ torch }] });
  } catch (e) {
    alert("–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ");
  }
};

rescanBtn.onclick = () => startScanner();

document.getElementById("clearHistory").onclick = () => {
  if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?")) {
    history = [];
    localStorage.removeItem("qrHistory");
    renderHistory();
  }
};

function startScanner() {
  document.getElementById("reader").innerHTML = "";
  qr = new Html5Qrcode("reader");
  qr.start(
    { facingMode: "environment" },
    { fps: 15, qrbox: { width: 180, height: 180 }, disableFlip: true },
    text => {
      qr.stop();
      parseQR(text);
    },
    () => {}
  );
}

renderHistory();
startScanner();
</script>

</body>
</html>
